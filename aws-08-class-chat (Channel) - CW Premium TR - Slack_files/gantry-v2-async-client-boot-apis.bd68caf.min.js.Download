(()=>{var et=Object.defineProperty;var c=(F,p)=>et(F,"name",{value:p,configurable:!0});(window.webpackJsonp=window.webpackJsonp||[]).push([["gantry-v2-async-client-boot-apis"],{CTVb:function(F,p,l){"use strict";l.r(p),l.d(p,"register",function(){return tt}),l.d(p,"test",function(){return $});var u=l("9oTK"),m=l("ifKl"),v=l("Lgge"),R=l("Xm7Q"),x=l("s4P+"),U=l("cznn"),W=l("Ki/W");function K(e){if(!e)return{};const t=e.history.messages,n=e.channel||e.group||e.im,a=n==null?void 0:n.id,o=e.history.channel_actions_count,i=Number.isInteger(o)?{channelId:a,count:o}:null;return{channelData:n,messagesData:{msgs:t,channelId:a,latest:t.length>0?t[0].ts:null,oldest:t.length>0?t[t.length-1].ts:null,hasMore:{hasMoreEnd:!1,hasMoreStart:e.history.has_more},isLimited:e.history.is_limited},membersData:e.users,botsData:e.bots,channelActionsData:i,mutationTimestampsData:e.history.mutation_timestamps}}c(K,"processMessagesData");var b=l("Omjo"),V=l("Pw4T"),g=l("KGIc");function L(e){let{featureFlagConfigVersionTs:t,experimentsConfigVersionTs:n,teamId:a}=e;t||Object(V.a)().count("mvb_missing_feature_flag_config_version"),n||Object(V.a)().count("mvb_missing_experiment_config_version"),Object(b.b)("BOOT",`Feature flag config version: ${t}; Experiments config version: ${n}`),Object(g.i)(a,Math.min(n,t));const o=Object(g.c)();o?Object(b.b)("BOOT",`Current earliest config version: ${o}; All config versions: ${Object(g.a)()}`):Object(x.b)().warn("BOOT",`Missing config version: ${o}; All config versions: ${Object(g.a)()}`)}c(L,"storeConfigVersion");var S=l("heB0");function w(e){return D.apply(this,arguments)}c(w,"maybeFetchAllOnboardingData");function D(){return D=Object(u.coroutine)(function*(e){let{apiData:t,contextualInfo:n}=e;const a={onboardingData:null,labFeaturesStartupData:null},{featureFlagData:o}=t,i=t.clientBootData;if(!i||!o)return a;const{userPrefsData:r}=i,s=!!(o!=null&&o.feature_composer_email_classification);var d;if(!((d=window.location.search.match("skip_onboarding"))!==null&&d!==void 0?d:!1)&&r&&!r.onboarding_complete){var f;a.onboardingData=yield Object(S.k)(n),!((f=a.onboardingData)===null||f===void 0)&&f.setup_started||s&&(a.labFeaturesStartupData=yield Object(S.j)(n))}return a}),D.apply(this,arguments)}c(D,"_maybeFetchAllOnboardingData");function E(e){let{viewData:t,channelsData:n=[]}=e;if(!(t!=null&&t.channelData))return n;const a=n.findIndex(o=>{var i;return o&&o.id===(t==null||(i=t.channelData)===null||i===void 0?void 0:i.id)});if(a!==-1){const o={...n[a],...t.channelData};n.splice(a,1,o)}return n}c(E,"maybeMergeKnownChannelsData");var O=l("mard"),J=l("60mp");function Q(e){return y.apply(this,arguments)}c(Q,"maybeReloadForReAuth");function y(){return y=Object(u.coroutine)(function*(e){let{clientBootData:t}=e;if(!(t==null?void 0:t.should_reauth))return;Object(b.b)("BOOT","Detected need to reauth; fetching auth and halting current boot.");const a=!1,o=!1,i=[],r=!0;return Object(J.d)(a,o,i,r),Object(O.a)()}),y.apply(this,arguments)}c(y,"_maybeReloadForReAuth");var z=l("wwBm"),P=l("qiCS"),G=l("kBpe"),N=l("gW03");function X(e){return C.apply(this,arguments)}c(X,"maybeRedirectToTermsOfService");function C(){return C=Object(u.coroutine)(function*(e){let{clientBootData:t}=e;var n;const a=t.acceptTosUrl;if(!a)return;const o=t==null||(n=t.teamData)===null||n===void 0?void 0:n.url;if(Object(G.i)()){const d=`${o}ssb/redirect`,h=Object(P.d)(a,"redirect",d),f=new N.a("User needs to accept Custom TOS");throw f.type=R.a.API,f.subType="custom_tos",f.data={error:"user_needs_to_accept_custom_tos",url:h},f}const i=Object(z.f)(location.search,"force_cold_boot",1),r=`${o}gantry${location.pathname}${i}`,s=Object(P.d)(a,"redirect",r);return Object(b.b)("BOOT",`(${t.teamData.id}) User needs to accept the terms of service; redirecting to ${s}`),location.assign(s),Object(O.a)()}),C.apply(this,arguments)}c(C,"_maybeRedirectToTermsOfService");var Z=l("ycWl"),H=l("31wZ");function Y(e){return j.apply(this,arguments)}c(Y,"maybeReloadForMinVersionBump");function j(){return j=Object(u.coroutine)(function*(e){let{clientBootData:t}=e;const{should_reload:n,client_min_version:a,recommended_build_version:o,build_manifest_last_modified:i}=t,r=Object(g.d)();if(parseInt(r??"0",10)&&n){if(Object(H.a)(a))return Object(Z.a)({reason:"Reloading due to a min version bump (client.boot)",reasonKey:"min_version_bump_client_boot",recommendedBuildVersion:o??void 0,buildManifestLastModified:i??void 0}),Object(O.a)();throw new Error("Unable to reload for min version bump at boot")}}),j.apply(this,arguments)}c(j,"_maybeReloadForMinVersionBump");function T(e){return B.apply(this,arguments)}c(T,"transformInitialApiResponses");function B(){return B=Object(u.coroutine)(function*(e){let{apiCalls:t,contextualInfo:n}=e;const{clientBootData:a,viewData:o,...i}=t,r=t.clientBootData.then(W.b);r.catch(m.a);const s=t.viewData.then(K);return s.catch(m.a),{apiCalls:{clientBootData:r,viewData:s,...i},contextualInfo:n}}),B.apply(this,arguments)}c(B,"_transformInitialApiResponses");function k(e){return I.apply(this,arguments)}c(k,"setConfigVersions");function I(){return I=Object(u.coroutine)(function*(e){let{apiCalls:t,contextualInfo:n}=e;const{teamId:a}=n;if(!a)return{apiCalls:t,contextualInfo:n};const{featureFlagData:o,experimentData:i}=t;return v.a.all([o,i]).then(r=>{let[s,d]=r;const{config_version_ts:h}=s,{config_version_ts:f}=d;L({featureFlagConfigVersionTs:h,experimentsConfigVersionTs:f,teamId:a})},()=>{}).catch(r=>{Object(x.b)().error("BOOT",`Failed to store config version: ${r}`)}),{apiCalls:t,contextualInfo:n}}),I.apply(this,arguments)}c(I,"_setConfigVersions");function q(e){return A.apply(this,arguments)}c(q,"startOnboardingApis");function A(){return A=Object(u.coroutine)(function*(e){let{apiCalls:t,contextualInfo:n}=e;const{getTracer:a,getTrace:o}=n.getTraceMeta(),i=o(),r=v.a.all([t.clientBootData,t.featureFlagData]).then(s=>{let[d,h]=s;return a().traceFn({name:"fetchOnboardingData",options:{traceId:i.getTraceId(),parentSpanId:i.getRootSpanId()}},w.bind(null,{apiData:{clientBootData:d,featureFlagData:h},contextualInfo:n}))}).catch(s=>{throw s.type=R.a.API,s.subType="allOnboardingData",s});return r.catch(m.a),{apiCalls:{allOnboardingData:r,...t},contextualInfo:n}}),A.apply(this,arguments)}c(A,"_startOnboardingApis");function _(e){return M.apply(this,arguments)}c(_,"maybeMergeChannelData");function M(){return M=Object(u.coroutine)(function*(e){let{apiCalls:t,contextualInfo:n}=e;const a=v.a.all([t.clientBootData,t.viewData]).then(o=>{let[i,r]=o;return{...i,channelsData:E({viewData:r,channelsData:i.channelsData})}});return a.catch(m.a),{apiCalls:{...t,clientBootData:a},contextualInfo:n}}),M.apply(this,arguments)}c(M,"_maybeMergeChannelData");function tt(e){e.hooks.apiAfterInitialCalls.tap("Transform initial API responses",T),e.hooks.apiAfterInitialCalls.tap("Maybe reload for a min version bump based on the client.boot response",function(){var t=Object(u.coroutine)(function*(n){let{apiCalls:a,contextualInfo:o}=n;const i=a.clientBootData.then(function(){var r=Object(u.coroutine)(function*(s){return yield Y({clientBootData:s}),s});return function(s){return r.apply(this,arguments)}}());return i.catch(m.a),{apiCalls:{...a,clientBootData:i},contextualInfo:o}});return function(n){return t.apply(this,arguments)}}()),e.hooks.apiAfterInitialCalls.tap("Store config versions",k),e.hooks.apiAfterInitialCalls.tap("Start onboarding APIs",q),e.hooks.apiAfterInitialCalls.tap("Merge view data with client.boot channels data",_),e.hooks.apiAfterInitialCalls.tap("Close API Boot Queue",U.a),e.hooks.apiAfterInitialCalls.tap("Maybe re-auth based on the client.boot response",function(){var t=Object(u.coroutine)(function*(n){let{apiCalls:a,contextualInfo:o}=n;const i=a.clientBootData.then(function(){var r=Object(u.coroutine)(function*(s){return yield Q({clientBootData:s}),s});return function(s){return r.apply(this,arguments)}}());return i.catch(m.a),{apiCalls:{...a,clientBootData:i},contextualInfo:o}});return function(n){return t.apply(this,arguments)}}()),e.hooks.apiAfterInitialCalls.tap("Maybe redirect to the terms of service based on the client.boot response",function(){var t=Object(u.coroutine)(function*(n){let{apiCalls:a,contextualInfo:o}=n;const i=a.clientBootData.then(function(){var r=Object(u.coroutine)(function*(s){return yield X({clientBootData:s}),s});return function(s){return r.apply(this,arguments)}}());return i.catch(m.a),{apiCalls:{...a,clientBootData:i},contextualInfo:o}});return function(n){return t.apply(this,arguments)}}())}c(tt,"register");const $={};Object.defineProperty($,"transformInitialApiResponses",{get:()=>T,set:e=>{T=e}})}}]);})();
