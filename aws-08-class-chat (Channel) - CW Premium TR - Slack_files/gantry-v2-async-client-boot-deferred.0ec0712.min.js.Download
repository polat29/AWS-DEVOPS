(()=>{var Pn=Object.defineProperty;var i=(ie,F)=>Pn(ie,"name",{value:F,configurable:!0});(window.webpackJsonp=window.webpackJsonp||[]).push([["gantry-v2-async-client-boot-deferred"],{tnTT:function(ie,F,r){"use strict";r.r(F),r.d(F,"register",function(){return Ln});var d=r("9oTK"),A=r("Omjo"),m=r("lhZz"),v=r("7xYR"),ce=r("I27i"),E=r("Lgge"),We=r("BEaa"),b=r("s4P+"),k=r("Pw4T"),x=r("Aqb/"),P=r("PLUl"),$e=r("31wZ"),le=r("Nf6b"),ue=r("4p6e"),de=r("uBea"),De=r("ycWl"),G=r("Z7Ay"),xe=r("6rGi");function Ge(){return Object(xe.a)().waitForHuddleToEnd()}i(Ge,"waitForHuddleToEnd");var _=r("KGIc"),w=r("G5NC"),me=r("+CZ0");const Ue=45*60*1e3,U=2e4,pe=3*60*60*1e3,Ye="MIN-VERSION",T="mvp",ze="mvb:stale",Ke="mvb:prev_poll_interval",Xe="mvb:check",He="mvb:prevent",Je="mvb:defer",Qe="mvb:defer:await_blur",Ze="mvb:defer:await_online",qe=.1,et=1;let N=!1;const tt=T;function Y(n){const e=Object(_.b)();return e?parseInt(e,10)<n:!1}i(Y,"isVersionStale");let nt=i(class{start(){if(this.pollTimer){this.logger.error("MinVersionPoll can only be started once");return}if(!N&&(Object(ue.a)()||Object(de.a)()))return;this.logger.info("Starting client min-version poll.");const e=Object(We.a)(Ue,.8,1.2);this.pollTimer=window.setInterval(()=>this.checkForMinVersionBumpAndMaybeReload(),e),this.initDebugger()}checkForMinVersionBumpAndMaybeReload(){var e=this;return Object(d.coroutine)(function*(){const t=e.logger,o=e.telemeter;e.lastPollTs=Date.now(),t.info("Checking to see if we should reload"),o.count(`${T}_check`);try{const s="polling",c=yield e.checkForMinVersionBump(s);if(!c){t.info("Missing client.shouldReload response. No need to reload");return}const{client_min_version:a,should_reload:u,reason:l,recommended_build_version:f,build_manifest_last_modified:p}=c;if(e.maybeStartTrace(a),e.maybeStartPreventReloadSpan(a),!u){t.info("No need to reload"),o.count(`${T}_shouldreload_prevent_api`),e.maybeIncrementPreventReloadReason(a,l);return}if(!Object($e.a)(a)){o.count(`${T}_shouldreload_prevent_client`),e.maybeIncrementPreventReloadReason(a,"client");return}e.maybeClosePreventReloadSpan(),t.info("Time to reload! Waiting until the client is online and unfocused."),e.isSafeToReloadRightNow()?o.count(`${T}_shouldreload_immediate`):(o.count(`${T}_shouldreload_will_defer`),e.isClientOnline()||o.count(`${T}_shouldreload_will_defer_offline`),e.maybeStartAwaitSafeTimeToReloadSpan(),yield e.awaitSafeTimeForReload(),e.maybeCloseAwaitSafeTimeToReloadSpan());const h="client.shouldReload told us to reload earlier; we are now unfocused and online";t.info(h),e.maybeCloseAndReportTrace();try{e.beforeReloadCallback()}catch(S){e.logger.error("MinVersionPoll: beforeReloadCallback failed with error",S)}Object(De.a)({reason:h,reasonKey:"client_should_reload",recommendedBuildVersion:f,buildManifestLastModified:p})}catch(s){t.error("client.shouldReload check failed",s)}})()}awaitSafeTimeForReload(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;var t=this;return Object(d.coroutine)(function*(){const o=t.telemeter,s=t.logger;return t.maybeIncrementRetryAttempts(e),E.a.all([t.awaitOnline(),t.awaitBlur()]).tap(()=>{s.info(`Online and unfocused, will wait ${U}ms to reload`)}).delay(U).then(()=>t.isSafeToReloadRightNow()?(o.count(`${T}_shouldreload_did_defer`),!0):(s.info(`Waited ${U} ms but now it is no longer safe to reload. Trying again...`),s.info(`Online: ${t.isClientOnline()}; Inactive: ${!t.isClientActive()||t.hasWaitedTooLongForBlur}; Retry attempts: ${e}`),t.awaitSafeTimeForReload(e+1)))})()}isClientActive(){return!!(document.hasFocus()||Object(w.a)()&&Object(me.c)(Object(m.getStateForClientStore)()))}isSafeToReloadRightNow(){return this.isClientOnline()&&(!this.isClientActive()||this.hasWaitedTooLongForBlur)}awaitBlur(){var e=this;return Object(d.coroutine)(function*(){if(!e.isClientActive()||e.hasWaitedTooLongForBlur)return!0;const t=e.logger,o=e.telemeter;e.awaitBlurPromise||(e.awaitBlurPromise=E.a.delay(pe).then(()=>{t.info(`Waited the max ${pe}ms for a blur event`),o.count(`${T}_shouldreload_waited_too_long_for_blur`),e.hasWaitedTooLongForBlur=!0})),e.maybeStartAwaitBlurSpan();const s=[];document.hasFocus()||(t.info("Waiting for blur event to reload"),s.push(Object(le.a)("blur"))),Object(w.a)()&&Object(me.c)(Object(m.getStateForClientStore)())&&(t.info("Waiting for huddle to end to reload"),s.push(Ge()));const c=E.a.all(s);return E.a.race([c,e.awaitBlurPromise]).tap(()=>{e.maybeCloseAwaitBlurSpan()})})()}awaitOnline(){var e=this;return Object(d.coroutine)(function*(){return e.isClientOnline()?!0:(e.logger.info("Waiting to come back online to reload"),e.maybeStartAwaitOnlineSpan(),Object(le.a)("online").tap(()=>{e.maybeCloseAwaitOnlineSpan()}))})()}initDebugger(){Object(G.a)("minVersionPoll",{checkAndMaybeReloadNow:()=>this.checkForMinVersionBumpAndMaybeReload(),checkNow:()=>this.checkForMinVersionBump("slackdebug"),getLastPollTime:()=>this.lastPollTs,timer:this.pollTimer})}maybeStartTrace(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;try{var t,o,s,c;if(!Y(e)||this.trace)return;const a={client_min_version:e,last_poll_ts:this.lastPollTs,method:"client.shouldReload",reason:"polling",metric_version:et},u=e*1e3,l=this.getLastSocketConnection(),f=Math.max(u,l);this.rootSpan=this.tracer.createSpan({name:ze,options:{startTime:f,tags:a},samplingOptions:{sampleType:x.a.SESSION,sampleRate:qe}});const p=this.tracer.createSpan({name:Ke,options:{startTime:f,tags:a,traceId:(t=this.rootSpan)===null||t===void 0?void 0:t.getTraceId(),parentSpanId:(o=this.rootSpan)===null||o===void 0?void 0:o.getId()}});p.close(),this.tracer.reportSpans([p]),this.trace=this.tracer.createTrace({traceName:Xe,traceId:(s=this.rootSpan)===null||s===void 0?void 0:s.getTraceId(),parentSpanId:(c=this.rootSpan)===null||c===void 0?void 0:c.getId(),tags:a})}catch{}}maybeStartPreventReloadSpan(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;try{if(!this.trace||!Y(e)||this.preventSpan)return;this.preventSpan=this.trace.startSpan(He)}catch{}}maybeClosePreventReloadSpan(){try{if(!this.trace||!this.preventSpan)return;this.preventSpan.close(),this.preventSpan=null}catch{}}maybeIncrementPreventReloadReason(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0;try{if(!this.trace||!Y(e)||!this.preventSpan)return;const o=`reason:${t||"unknown"}`,s=this.preventSpan.getTag(o)||0;this.preventSpan.setTag(o,s+1)}catch{}}maybeStartAwaitSafeTimeToReloadSpan(){try{if(!this.trace||this.awaitSafeTimeForReloadSpan)return;this.awaitSafeTimeForReloadSpan=this.trace.startSpan(Je,{tags:{is_online:this.isClientOnline(),is_blurred:!document.hasFocus(),has_waited_too_long_for_blur:this.hasWaitedTooLongForBlur}})}catch{}}maybeCloseAwaitSafeTimeToReloadSpan(){try{if(!this.trace||!this.awaitSafeTimeForReloadSpan)return;this.awaitSafeTimeForReloadSpan.close(),this.awaitSafeTimeForReloadSpan=null}catch{}}maybeStartAwaitOnlineSpan(){try{var e;if(!this.trace||this.awaitOnlineSpan)return;this.awaitOnlineSpan=this.trace.startSpan(Ze,{parentSpanId:(e=this.awaitSafeTimeForReloadSpan)===null||e===void 0?void 0:e.getId()}),this.maybeIncrementAwaitOnlineAttempts()}catch{}}maybeCloseAwaitOnlineSpan(){try{if(!this.trace||!this.awaitOnlineSpan)return;this.awaitOnlineSpan.close(),this.awaitOnlineSpan=null}catch{}}maybeStartAwaitBlurSpan(){try{var e;if(!this.trace||this.awaitBlurSpan)return;this.awaitBlurSpan=this.trace.startSpan(Qe,{parentSpanId:(e=this.awaitSafeTimeForReloadSpan)===null||e===void 0?void 0:e.getId()}),this.maybeIncrementAwaitBlurAttempts()}catch{}}maybeCloseAwaitBlurSpan(){try{if(!this.trace||!this.awaitBlurSpan)return;this.awaitBlurSpan.addTags({is_blurred:!document.hasFocus(),has_waited_too_long_for_blur:this.hasWaitedTooLongForBlur}),this.awaitBlurSpan.close(),this.awaitBlurSpan=null}catch{}}maybeIncrementRetryAttempts(e){try{if(!this.trace||!this.awaitSafeTimeForReloadSpan)return;this.awaitSafeTimeForReloadSpan.setTag("total_retry_attempts",e)}catch{}}maybeIncrementAwaitOnlineAttempts(){try{if(!this.trace||!this.awaitSafeTimeForReloadSpan)return;const e="await_online_attempts",t=this.awaitSafeTimeForReloadSpan.getTag(e)||0;this.awaitSafeTimeForReloadSpan.setTag(e,t+1)}catch{}}maybeIncrementAwaitBlurAttempts(){try{if(!this.trace||!this.awaitSafeTimeForReloadSpan)return;const e="await_blur_attempts",t=this.awaitSafeTimeForReloadSpan.getTag(e)||0;this.awaitSafeTimeForReloadSpan.setTag(e,t+1)}catch{}}maybeCloseAndReportTrace(){try{var e;if(!this.trace||!this.trace||!this.rootSpan)return;(e=this.rootSpan)===null||e===void 0||e.close(),this.tracer.reportTrace(this.trace),this.tracer.reportSpans([this.rootSpan]),this.trace=null,this.rootSpan=null}catch{}}testOnlyReset(){if(!Object(ue.a)()&&!Object(de.a)())throw new Error("MinVersionPoll.reset should only be called in test files!");clearInterval(this.pollTimer),this.pollTimer=null,this.awaitBlurPromise&&(this.awaitBlurPromise.cancel(),this.awaitBlurPromise=null),this.lastPollTs=null,this.hasWaitedTooLongForBlur=!1}constructor({checkForMinVersionBump:e,beforeReloadCallback:t,getLastSocketConnection:o,isClientOnline:s,logger:c=Object(b.b)({label:Ye}),telemeter:a=Object(k.a)(),tracer:u=Object(P.a)()}){this.hasWaitedTooLongForBlur=!1,this.awaitBlurPromise=null,this.pollTimer=null,this.lastPollTs=null,this.rootSpan=null,this.trace=null,this.preventSpan=null,this.awaitSafeTimeForReloadSpan=null,this.awaitOnlineSpan=null,this.awaitBlurSpan=null,this.checkForMinVersionBump=e,this.beforeReloadCallback=t,this.getLastSocketConnection=o,this.logger=c,this.telemeter=a,this.tracer=u,this.isClientOnline=s}},"MinVersionPoll");Object.defineProperty({forceStartMinVersionPollInTests:N},"forceStartMinVersionPollInTests",{get:()=>N,set:n=>{N=n}});var ot=r("WUSA"),rt=r("nNoG"),at=r("S1sa"),st=r("CpTu"),it=r("fujP"),ct=r("YsUP"),lt=r("WCk1"),L=r("ykb+"),ut=r("PY4h");const z=Object(lt.a)("Check to see whether we need to reload",function(){var n=Object(d.coroutine)(function*(e,t,o){let{reason:s="unknown",teamIds:c=[],skipExpiryCheck:a=!1}=o;const u=Object(b.b)();if(Object(L.c)())return u.warn("MIN-VERSION","Cannot check whether to reload when using js_path. Skipping client.shouldReload call."),{should_reload:!1,reason:"js_path"};if(!Object(w.a)())throw new Error("client.shouldReload should only be used in the client.");const l=Object(_.e)();if(!l)throw new Error("Cannot check whether to reload if we\u2019re missing versionTs");const f=Object(_.d)(),p=parseInt(f??"",10),h={versionTs:l,reason:s,buildVersionTs:p,skipExpiryCheck:a};Object(it.a)(c)||(h.teamIds=c),Object(ct.a)(p)&&Object(b.b)().error("MIN-VERSION",`Invalid build version timestamp: ${f}`);const S=Object(_.c)();S&&(h.configVersionTs=S),Object(b.b)().info("MIN-VERSION",`teamIds: ${(c==null?void 0:c.join(","))||"NONE"}; versionTs: ${l}; buildVersionTs: ${p}; configVersionTs: ${S}; All config versions: ${Object(_.a)()}`);try{return e(Object(ut.a)(h))}catch(O){var j;throw(O==null||(j=O.data)===null||j===void 0?void 0:j.error)==="invalid_arguments"&&Object(b.b)().error(`client.shouldReload failed with invalid arguments: team_ids=${c.join(",")}; version=${h.buildVersionTs}`,O),O}});return function(e,t,o){return n.apply(this,arguments)}}());z.meta={name:"createFetcher",key:"createFetcherclientShouldReloadImmediately",description:"Check to see whether we need to reload"};var dt=r("ZKjC"),fe=r("g8rC");const he="govslack_min_version_bumps",be="on",ge=Object(dt.b)(n=>Object(fe.a)(n,he,be));ge.meta={name:"createSelector",key:"createSelectorisGovSlackMinVersionBumpsToggleEnabledForAnyTeam",description:n=>Object(fe.a)(n,he,be)};var mt=ge,pt=r("VHGx"),ft=r("IU/j");const ht={is_expired:!1,ok:!0},bt={is_expired:!1,ok:!1};function gt(n){return K.apply(this,arguments)}i(gt,"clientCheckVersion");function K(){return K=Object(d.coroutine)(function*(n){let{teamIds:e,enterpriseIds:t}=n;if(Object(L.c)())return Object(b.b)().warn("MIN-VERSION","Cannot check whether to reload when using js_path. Skipping client.checkVersion call."),ht;if(!Object(w.a)())throw new Error("client.checkVersion should only be used in the client.");try{var o;const s={team_ids:e,enterprise_ids:t,build_version_ts:parseInt((o=Object(_.d)())!==null&&o!==void 0?o:"",10)},c=Object(_.c)();c&&(s.config_version_ts=c);const a=vt(s),u=yield pt.b.fetch({url:"/api/client.checkVersion",httpMethod:"POST",payload:a});return JSON.parse(u)}catch(s){return Object(b.b)().error("Failed to fetch/parse client.checkVersion response",s),bt}}),K.apply(this,arguments)}i(K,"_clientCheckVersion");function vt(n){return Object(ft.a)(n,"client.checkVersion")}i(vt,"getClientCheckVersionPayload");var ve=r("AdD7"),Ot=r("kIXQ");const Oe="MIN-VERSION";function St(n){return X.apply(this,arguments)}i(St,"check_for_min_version_bump_checkForMinVersionBump");function X(){return X=Object(d.coroutine)(function*(n){const e=Object(m.getClientStoreInstance)();if(Object(ve.b)()&&mt(e.getState()))return jt(n);const t=Object(v.getFocusedWorkspace)(e.getState()),o=Object(m.getStoreInstanceByTeamId)(t),s=Object(v.getBootedWorkspaces)(e.getState());return o.dispatch(z({teamIds:s,reason:n}))}),X.apply(this,arguments)}i(X,"_checkForMinVersionBump");function jt(n){return H.apply(this,arguments)}i(jt,"checkForMinVersionBumpInGovClients");function H(){return H=Object(d.coroutine)(function*(n){const e=Object(m.getClientStoreInstance)();var t;const o=(t=Object(v.getBootedWorkspaces)(e.getState()))!==null&&t!==void 0?t:[],s=Object(v.getBootedOrgs)(e.getState()),{is_expired:c,client_min_build_version:a,recommended_build_version:u,build_manifest_last_modified:l}=yield gt({teamIds:o,enterpriseIds:s});if(!c)return{should_reload:!1,client_min_version:a,recommended_build_version:u,build_manifest_last_modified:l};const f=Object(P.a)(),p=f.createMetricsTrace({label:"gov_mvb",samplingOptions:{sampleType:x.a.ALWAYS}}),[h,S]=Object(at.a)(o,I=>Object(Ot.b)(I));p.addTags({client_min_version:a,recommended_build_version:u,build_manifest_last_modified:l,has_gov_teams:!!h.length,has_commercial_teams:!!S.length});const{should_reload:j,reason:O}=yield Se({teamIds:h,reason:n});if(!j)return p.count({name:"prevent"}).addTags({environment:"gov",reason:O??"none"}),f.reportTrace(p),Object(b.b)().info(Oe,`Gov teams failed rate limit check with reason ${O??"none"}; Preventing reload. teams: (${h.join(",")}) `),{should_reload:!1,client_min_version:a,recommended_build_version:u,build_manifest_last_modified:l,reason:O};const{should_reload:D,reason:y}=yield Se({teamIds:S,reason:n});return D?(p.count({name:"reload"}),f.reportTrace(p),{should_reload:!0,client_min_version:a,recommended_build_version:u,build_manifest_last_modified:l}):(p.count({name:"prevent"}).addTags({environment:"commercial",reason:y??"none"}),f.reportTrace(p),Object(b.b)().info(Oe,`Commercial teams failed rate limit check with reason ${y??"none"}; Preventing reload. teams: (${S.join(",")})`),{should_reload:!1,client_min_version:a,recommended_build_version:u,build_manifest_last_modified:l,reason:y})}),H.apply(this,arguments)}i(H,"_checkForMinVersionBumpInGovClients");function Se(n){return J.apply(this,arguments)}i(Se,"shouldClientReloadForTeams");function J(){return J=Object(d.coroutine)(function*(n){let{teamIds:e,reason:t}=n;const o=yt(e);return o?o.dispatch(z({teamIds:e,reason:t,skipExpiryCheck:!0})):{should_reload:!0}}),J.apply(this,arguments)}i(J,"_shouldClientReloadForTeams");function yt(n){const e=Object(st.a)(n,t=>!!Object(m.getStoreInstanceByTeamId)(t));if(e)return Object(m.getStoreInstanceByTeamId)(e)}i(yt,"findAnyStoreInstanceForTeamIds");const Tt=new rt.b("min-version-poll");let je=!1;function It(){const n=Object(m.getClientStoreInstance)();var e;const t=new nt({isClientOnline:()=>!!Object(ce.d)(n.getState()),checkForMinVersionBump:St,getLastSocketConnection:()=>(e=Object(ce.h)(n.getState()))!==null&&e!==void 0?e:0,beforeReloadCallback:()=>{ye()}});if(je){Object(A.c)("MinVersionPoll can\u2019t be started more than once!");return}t.start(),je=!0,Object(k.a)().count(`${tt}_start_2`)}i(It,"registerMinVersionPoll");function ye(){if(!Object(w.a)())return;const n=Object(m.getClientStoreInstance)(),e=Object(v.getFocusedWorkspace)(n.getState());Object(m.getStoreInstanceByTeamId)(e).dispatch(Object(ot.a)({message:Tt.t("Reloading Slack\u2026"),assertive:!0}))}i(ye,"notifyAboutReloadAccessibly");const Vn={notifyAboutReloadAccessibly:ye};var R=r("kBpe");const _t=3*60*1e3,Te=60*60*1e3,Ie=10*60*1e3,Rt="ssb-memory-stats";var _e=r("kiPk"),g=r("vfQU"),V=r("xt0X"),Mt=r("U28S");const Re=Object(b.b)();function Ct(n){return Me(n)}i(Ct,"fetchMemoryStats");const At=[["workingSetSize",""],["peakWorkingSetSize","peak_"],["privateBytes","private_"]];let Q;function Me(n){return(g.A.isAvailable()?Object(g.A)():Object(g.z)()).then(e=>{const t={},o=e.processMetrics||e;if(!o||o.length===0)return Re.warn("STATS",`No memory stats collected getAppMetrics:${o}`,{subtype:"stats_no_memory"}),t;if(navigator&&navigator.hardwareConcurrency){const c=Object(_e.a)(o,a=>{let{cpu:u}=a;return u.percentCPUUsage*navigator.hardwareConcurrency});t[`cpu_v5_app_${n}_teams`]=Object(Mt.b)(c,2)}o.forEach(c=>{let{type:a,memory:u}=c;At.forEach(l=>{let[f,p]=l;if(f in u){const h=`memory_v5_app_${p}mb_${n}_teams_${a.toLowerCase()}_process`;h in t||(t[h]=0),t[h]+=Math.round(Object(V.b)(u[f]))}})});const s=Z(o,"workingSetSize");return t[`memory_v5_app_mb_${n}_teams`]=s,Q&&(t[`memory_v5_app_mb_delta_${n}_teams`]=s-Q),Q=s,t[`memory_v5_app_peak_mb_${n}_teams`]=Z(o,"peakWorkingSetSize"),Object(R.x)()&&(t[`memory_v5_app_private_mb_${n}_teams`]=Z(o,"privateBytes")),Et(t,5,n),t}).catch(e=>Re.error("STATS",`getAppMetrics failed: ${e.message}`))}i(Me,"fetchMemoryStatsV5");function Z(n,e){const t=Object(_e.a)(n,o=>{let{memory:s}=o;return s[e]});return Math.ceil(Object(V.b)(t))}i(Z,"sumMemoryMetricsByKey");function Et(n,e,t){window.performance&&window.performance.memory&&(n[`heap_v${e}_used_mb_${t}_teams`]=Object(V.a)(performance.memory.usedJSHeapSize),n[`heap_v${e}_total_mb_${t}_teams`]=Object(V.a)(performance.memory.totalJSHeapSize))}i(Et,"addJSHeapMetrics"),Object(G.a)("ssbMetrics",{fetchMemoryStatsV5:Me});function Bt(){if(!Object(R.i)())return E.a.resolve();const n=Object(k.a)(),e=Object(P.a)(),t=e.createMetricsTrace({label:Rt});function o(){const c=Object(m.getStateForClientStore)(),a=Object(v.getBootedWorkspaces)(c),u=a?a.length:0;return Ct(u).then(l=>l?(Object.keys(l).forEach(p=>{n.store(p,l[p],{allow_negative:p.indexOf("delta")!==-1});const h=/_\d+?_teams/;t.store({name:p.replace(h,""),value:l[p]}).addTags({num_teams:u})}),e.reportTrace(t),l):null)}i(o,"fetchStatsAndBeacon");const s=Te+Math.floor(Math.random()*Ie);return setInterval(()=>o(),s),setTimeout(()=>o(),_t),E.a.resolve()}i(Bt,"storeSSBMemoryStatsOnAnInterval");var W=r("Fsnq"),kt=r("owWc"),wt=r("xwCZ"),Lt=r("Wjv9"),B=r("RVJP"),q=r("1Np4"),$=r("thso");function Ft(){const n="store_metrics_v3";function e(){const o=Object(m.getStateForClientStore)(),s=Object(v.getBootedWorkspaces)(o);s&&s.forEach(c=>{const a=Object(m.getStateByTeamId)(c);if(!a)return;const u=Object(q.a)({state:a}),l=u.createMetricsTrace({label:n}),f=l.startSpan(`${n}:size_compute_time`),p=Object(W.a)(a.files);l.store({name:`${n}:files:count`,value:p});const h=Object(W.a)(Object($.b)(Object(wt.b)(a)));l.store({name:`${n}:members:count`,value:h});const S=Object(W.a)(Object($.b)(a.channels));l.store({name:`${n}:channels:count`,value:S});const j=Object(kt.a)(Object($.b)(Object(Lt.a)(a)),(I,Fn)=>I+Object(W.a)(Object($.b)(Fn)),0);l.store({name:`${n}:messages:count`,value:j}),l.store({name:`${n}:total:count`,value:p+h+S+j});const O=Object(B.d)(a,"members_store_cache_eviction");O&&l.store({name:`${n}:members:count`,value:h}).addTags({group:O});const D=Object(B.d)(a,"messages_cache_eviction");D&&l.store({name:`${n}:messages:count`,value:j}).addTags({group:D});const y=Object(B.d)(a,"channels_cache_eviction");y&&l.store({name:`${n}:channels:count`,value:S}).addTags({group:y}),Object(B.d)(a,"aggressive_messages_cache_eviction")==="treatment"&&l.store({name:"cache_messages_aggressive_store_size",value:j}).addTags({group:"treatment"}),Object(B.d)(a,"aggressive_messages_cache_eviction")==="control"&&l.store({name:"cache_messages_aggressive_store_size",value:j}).addTags({group:"control"}),f.close(),u.reportTrace(l)})}i(e,"fetchStatsAndBeacon");const t=Te+Math.floor(Math.random()*Ie);setInterval(()=>e(),t)}i(Ft,"storeReduxStoreStatsOnAnInterval");var Pt=r("2um6");function Nt(){try{const n=Object(m.getClientStoreInstance)();if(!n)return;const e=Object(v.getFocusedWorkspace)(n==null?void 0:n.getState());if(!e)return;const t=Object(m.getStoreInstanceByTeamId)(e);if(!t)return;Object(Pt.l)(t)}catch(n){Object(b.b)().warn("BOOT-CLIENT","trying to set default accessibility preferences failed",n)}}i(Nt,"updateA11yPreferences");var Vt=r("nzWX"),ee=r("d/xU");function Wt(){Object(g.db)()&&Object(Vt.d)("ssb_instance_id",Object(g.N)(),365*10,`.${Object(ee.n)()}`)}i(Wt,"setUpSSBInstanceCookie");var M=r("Fvov");const $t=i(()=>{if(!Object(R.r)()){Object(A.b)("BOOT","Service Worker unavailable; Skipping registration.");return}Object(M.c)()},"registerServiceWorkerOnBoot");var Dt=r("qiCS");const xt=["force_cold_boot","new_enough_acceptable"];function Gt(){!Object(L.e)()||Object(L.c)()||window.isReloading||xt.forEach(n=>{if(!window.location.search.match(n))return;const e=Object(Dt.b)(window.location.href,n);window.history.replaceState(window.history.state,"",e),Object(A.b)("BOOT",`cleared ${n} flag`)})}i(Gt,"clearReloadURLState");var Ut=r("KLFD"),Yt=r("VnPF");function zt(){return te.apply(this,arguments)}i(zt,"cleanUpOldPersistedData");function te(){return te=Object(d.coroutine)(function*(){const n=Object(Ut.a)();yield Object(Yt.a)(n)}),te.apply(this,arguments)}i(te,"_cleanUpOldPersistedData");var Kt=r("vnlm");function Xt(){const n=Object(m.getClientStoreInstance)();Object(v.getBootedWorkspaces)(n.getState()).forEach(t=>{const o=Object(m.getStoreInstanceByTeamId)(t);Object(Kt.b)({teamId:t,store:o})})}i(Xt,"persistNewData");var Ht=r("fUOF");function Jt(){if(!Object(R.i)()||!Object(R.p)())return;const n=Object(Ht.a)("squirrel_mac_direct_contents_write","on");g.ec.isAvailable()?(Object(A.b)("BOOT",`Setting Squirrel Mac Direct Contents Write = ${n?"enabled":"disabled"}`),Object(g.ec)(n)):Object(A.b)("BOOT","setSquirrelMacDirectContentsWriteEnabled not available")}i(Jt,"setUpSquirrelMacDirectContentsWrite");var Qt=r("0akA"),Zt=r("JN2d"),qt=r("t4eE"),ne=r("j77i");const en="recentlyUsedTeamIds",tn="mostRecentlyUsedDate",Ce=10;function nn(){if(!Object(qt.b)())return;const n=Object(ne.g)(en)||[];if((n==null?void 0:n.length)<=Ce)return;const e=n.slice(Ce),t=Object(Zt.a)();e.forEach(o=>{const s=t[o];if(!s)return;const c=s[tn];if(!c)return;const a=Object(Qt.a)(new Date,new Date(c));Object(k.d)({teamOrEnterpriseId:o}).store("least_recently_used_workspaces_last_use",a)})}i(nn,"reportLongTailTeamUsage");var on=r("LqbL");function rn(){Object(m.getClientStoreInstance)().dispatch(Object(on.setDidBootAllWorkspaces)()),Object(b.b)().info("BOOT","Client boot completed"),Object(k.a)().count("sonic_boot_completed")}i(rn,"markBootComplete");var Ae=r("dSGR");const C="is_sonic_on_gantry_v2_enabled";var oe;(function(n){n.ROLLBACK="rollback",n.ROLLOUT="rollout"})(oe||(oe={}));function Ee(){return re.apply(this,arguments)}i(Ee,"saveSonicOnGantryV2ExperimentToSW");function re(){return re=Object(d.coroutine)(function*(){try{if(Object(ve.b)())return;const n=Object(ne.g)(Ae.a);Object(ne.v)(Ae.a,void 0);const e=!!(yield Object(M.b)({key:C}));if(!n){e&&(yield Object(M.a)({key:C}));return}if(e)return;Object(b.b)().info("BOOT",`Writing SoGv2 assignment (${n}) to Service Worker.`),yield Object(M.e)({key:C,value:n});const t=Object(P.a)(),o=t.createSpan({name:C,options:{tags:{action:oe.ROLLOUT,is_sonic_on_gantry_v2_enabled:n}},samplingOptions:{sampleType:x.a.ALWAYS}});t.reportSpans([o])}catch(n){Object(b.b)().error("GANTRY-BOOT","Failed to read/store Sonic on Gantry V2 group in cache",n)}}),re.apply(this,arguments)}i(re,"_saveSonicOnGantryV2ExperimentToSW"),Object(G.a)("sonicOnGantryV2Toggle",{saveToggleState:function(){var n=Object(d.coroutine)(function*(e){yield Object(M.e)({key:C,value:e})});return function(e){return n.apply(this,arguments)}}(),clearToggleState:Object(d.coroutine)(function*(){yield Object(M.a)({key:C})}),getToggleState:()=>Object(M.b)({key:C}),saveSonicOnGantryV2ExperimentToSW:Ee});var Be=r("XzGp"),an=r("qCdX"),sn=r("pOPU");function cn(){try{Object(an.b)(),Object(sn.b)(),Object(Be.a)()}catch(n){Object(b.b)().error("Failed to report client metrics",n)}}i(cn,"reportClientMetrics");var ln=r("5TXe"),un=r("9Gfp"),ke=r("SQ0V"),we=r("O86Y"),dn=r("2mvv"),mn=r("pmGC");const Le=Object(ke.c)("Signal to the desktop that all delegates are ready",(n,e)=>{Object(g.q)(),hn(e),fn(e)});Le.meta={name:"createThunk",key:"createThunkonWebappBooted",description:"Signal to the desktop that all delegates are ready"};var pn=Le;const Fe=new Set;function fn(n){setTimeout(Object(d.coroutine)(function*(){var e;const t=n(),o="ssb",s=Object(dn.b)(t),c=Object(we.g)(t),a=Object(we.d)(t);if(a){if(Fe.has(a))return;Fe.add(a)}const u=yield ln.a.fetch({method:"api.features",args:{token:s,platform:o},teamId:c}),l=u==null||(e=u.features)===null||e===void 0?void 0:e.desktop_diagnostics_timestamp;if(l){const f=Object(b.a)({teamId:c,label:"CLIENT-LOGS"});f.info(`Received request ${l} for logs ON BOOT; sending them up...`);try{yield Object(Be.b)()}catch(p){f.warn(`Error running client metrics ON BOOT for request ${l}: ${p}`)}Object(mn.a)(c)}}),6e4)}i(fn,"maybeUploadLogs");function hn(n){Object(un.i)(n(),"feature_desktop_system_notification_playback")&&Object(g.I)("settings","notificationPlayback")&&Object(g.cc)({name:"notificationPlayback",value:"system"})}i(hn,"maybeForceNotificationPlayback");const bn="SIGNAL-TO-DESKTOP";function gn(){if(!Object(R.i)())return;const e=Object(m.getClientStoreInstance)().getState(),t=Object(v.getFocusedWorkspace)(e);(t?Object(b.a)({teamId:t}):Object(b.b)()).info(bn,"Attempted boot for all workspaces, signaling desktop");for(const s of Object(v.getBootedWorkspaces)(e)||[])Object(m.dispatchForTeamId)(s,pn())}i(gn,"maybeSignalBootedToDesktop");var ae=r("4cU5");function vn(){const e=Object(m.getClientStoreInstance)().getState(),t=Object(v.getBootedWorkspaces)(e),o=Object(v.getFocusedWorkspace)(e),c=Object(m.getStoreInstanceByTeamId)(o).getState(),a=Object(q.a)({state:c}),u=a.createSpan({name:"workspaces:booted",samplingOptions:{sampleType:ae.g.ALWAYS},options:{tags:{count:t.length}}});u.close(),a.reportSpans([u])}i(vn,"beaconWorkspacesCount");var On=r("On6p");const Sn=1e3*60*30;function jn(n){const e=i(()=>{const t=n.createSpan({name:"desktop_dogfood:active",samplingOptions:{sampleType:ae.g.ALWAYS},options:{tags:{ssb_version:Object(g.Oc)(),ssb_instance_id:Object(g.N)(),ssb_platform:Object(g.H)(),unrefined:!0}}});t.close(),n.reportSpans([t])},"report");setInterval(e,Sn),e()}i(jn,"queueDesktopDogfoodActivityInterval");function yn(){if(Object(R.i)()&&Object(g.S)()===On.a)try{const e=Object(m.getClientStoreInstance)().getState(),t=Object(v.getFocusedWorkspace)(e),s=Object(m.getStoreInstanceByTeamId)(t).getState(),c=Object(q.a)({state:s}),a=c.createSpan({name:"desktop_dogfood:booted",samplingOptions:{sampleType:ae.g.ALWAYS},options:{tags:{ssb_version:Object(g.Oc)(),ssb_instance_id:Object(g.N)(),ssb_platform:Object(g.H)(),unrefined:!0}}});a.close(),c.reportSpans([a]),jn(c)}catch(n){Object(b.b)().error("Failed to report dogfood boot",n)}}i(yn,"setupDesktopDogfoodMetricReporter");var Tn=r("sMre"),Pe=r("Ybt4"),In=r("5NQM"),_n=r("z28c");const Ne=4,Rn=i(n=>1e4*2**n,"getDelayForAttempt"),se=Object(ke.c)("Preload Collab SDK after boot",function(n,e){let{attempt:t=1}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return n(Object(Tn.a)()).then(o=>{if(navigator&&navigator.serviceWorker&&navigator.serviceWorker.controller){var c,a;navigator==null||(c=navigator.serviceWorker)===null||c===void 0||(a=c.controller)===null||a===void 0||a.postMessage({type:"canvas_prefetch",urls:o.controllerModuleUrls()})}else Object(B.d)(e(),"rm_preload_quip")!=="treatment"&&o.preload()}).catch(o=>{Object(Pe.b)({getState:e}).error(o,`Error preloading Quip SDK (${t} / ${Ne})`),t<Ne&&setTimeout(()=>{n(se({attempt:t+1}))},Rn(t))})});se.meta={name:"createThunk",key:"createThunkpreloadQuip",description:"Preload Collab SDK after boot"};function Mn(){const n=Object(m.getStateForClientStore)(),e=Object(v.getBootedWorkspaces)(n)||[];try{const t=e.find(o=>{const s=Object(m.getStateByTeamId)(o);return Object(_n.a)(s)});if(!t)return;Object(In.c)(()=>{Object(m.dispatchForTeamId)(t,se())},{timeout:2e3})}catch(t){Object(Pe.c)().error(t,"Error preloading Quip SDK")}}i(Mn,"initPreloadQuip");var Cn=r("a9XA");function An(){const n=Object(m.getClientStoreInstance)();if(n)try{const e=n.getState(),t=Object(v.getFocusedWorkspace)(e);Object(m.getStoreInstanceByTeamId)(t).dispatch(Object(Cn.a)())}catch(e){Object(b.b)().error("BOOT","Failed to show Day 1 Creator welcome modal",e)}}i(An,"maybeShowDay1CreatorWelcomeModalAtBoot");function En(n){let e="";for(let t=0;t<n.classList.length;t++)e+=`.${n.classList[t]}`;return e}i(En,"describeClasses");function Bn(n){return n.id?`#${n.id}`:""}i(Bn,"describeId");function Ve(n){return[n.tagName.toLowerCase(),En(n),Bn(n)].join("")}i(Ve,"describeDomElement");function kn(n){let e=Ve(n),t=n;for(;t.parentElement;)t=t.parentElement,e=`${Ve(t)} > ${e}`;return e}i(kn,"describeDomLocation");function wn(){if(!("ReportingObserver"in window))return;const n=Object(L.b)()?`https://${Object(ee.i)()}/events/report`:`https://${Object(ee.o)()}/events/report`;try{new window.ReportingObserver(e=>{for(const t of e)if(t.type==="coep"&&t.body){const o=t.body.toJSON(),{blockedURL:s,destination:c}=o;if(c==="image"&&s){const a=document.getElementsByTagName("img");for(let u=0;u<a.length;u++){const l=a[u];if(l.src===s){o.html=l.outerHTML;try{o.domLocation=kn(l)}catch(f){o.domLocationError=f.message}fetch(n,{method:"POST",body:JSON.stringify({type:"coep-enriched",url:t.url,body:o})});break}}}}},{buffered:!0}).observe()}catch(e){Object(A.c)("BOOT","Error creating ReportingObserver",e)}}i(wn,"enrichCoepReports");function Ln(n){n.hooks.bootComplete.tap("Begin min version polling",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return It(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}()),n.hooks.bootComplete.tap("Prepare to record SSB memory usage stats on an interval",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return Bt(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}()),n.hooks.bootComplete.tap("Prepare to record Redux store size stats on an interval",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return Ft(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}()),n.hooks.bootComplete.tap("Update accessibility preferences",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return Nt(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}()),n.hooks.bootComplete.tap("Set-up a cookie with the SSB instance ID to send along with API requests",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return Wt(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}()),n.hooks.bootComplete.tap("Register the service worker",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return $t(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}()),n.hooks.bootComplete.tap("Clear force_cold_boot and new_enough_acceptable params from URL",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return Gt(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}()),n.hooks.bootComplete.tap("Clean up old persisted data for expired teams",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return yield zt(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}()),n.hooks.bootComplete.tap("Persist data for all booted teams",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return Xt(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}()),n.hooks.bootComplete.tap("Enable the direct-contents-write feature of Squirrel.Mac on Mac SSB",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return Jt(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}()),n.hooks.bootComplete.tap("Collect data on how long it's been since people have used their least active teams",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return nn(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}()),n.hooks.bootComplete.tap("Mark the client boot as complete",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return rn(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}()),n.hooks.bootComplete.tap("(Desktop only) Signal to desktop that all teams have booted",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return gn(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}()),n.hooks.bootComplete.tap("Preload quip assets",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return Mn(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}()),n.hooks.bootComplete.tap("Maybe show Day 1 creator welcome modal",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return An(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}()),n.hooks.bootComplete.tap("Collect client metrics on an interval",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return cn(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}()),n.hooks.bootComplete.tap("Write sonic_on_gantry_v2 flag to the service worker",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return Ee(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}()),n.hooks.bootComplete.tap("Record a count of booted teams",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return vn(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}()),n.hooks.bootComplete.tap("Install a ReportingObserver to enrich COEP reports",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return wn(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}()),n.hooks.bootComplete.tap("Report dogfood metrics",function(){var e=Object(d.coroutine)(function*(t){let{contextualInfo:o}=t;return yn(),{contextualInfo:o}});return function(t){return e.apply(this,arguments)}}())}i(Ln,"register")}}]);})();
